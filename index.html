<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CityReport - Inicio</title>

  <link rel="stylesheet" href="css/estilos.css" />
  <link rel="stylesheet" href="css/nav.css" />

  <link rel="stylesheet" href="css/theme.css" />
</head>
<body>
  <header class="main-header">
    <div class="header-container">
      <div class="logo-container">
        <a href="index.html" class="logo-link header-logos">
          <img src="img/urbano.png" alt="Urbano" class="logo-img logo-urbano" />
          <img src="img/logo_city.png" alt="CityReport" class="logo-img logo-city" />
        </a>
      </div>

      <div class="header-title">
        <h1>CityReport</h1>
        <div class="header-subtitle">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
          </svg>
          Panel de administración
        </div>
      </div>

      <nav class="main-nav">
        <a href="index.html" class="nav-link active">Inicio</a>
        <a href="reportes_consultar.html" class="nav-link">Reportes</a>
        <a href="estadisticas.html" class="nav-link">Estadísticas</a>
        <!-- Solo admin -->
        <a href="usuarios.html" class="nav-link" data-role-allow="1">Usuarios</a>
        <a href="#" id="logout-link" class="nav-link">Cerrar sesión</a>
      </nav>
    </div>
  </header>

  <main class="principal">
    <div class="dashboard-grid">
      <div class="welcome-card card">
        <div class="welcome-time"><span id="current-time">Cargando hora...</span></div>
        <h2 class="welcome-heading">Bienvenido a CityReport</h2>
        <p id="saludo" class="welcome-message">Cargando...</p>

        <div class="stats-preview">
          <div class="stat-item">
            <div class="stat-value" id="total-reportes">--</div>
            <div class="stat-label">Total Reportes</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="reportes-pendientes">--</div>
            <div class="stat-label">Pendientes</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="reportes-resueltos">--</div>
            <div class="stat-label">Resueltos</div>
          </div>
        </div>

        <div class="action-buttons" style="display:flex;flex-wrap:wrap;gap:.6rem">
          <a class="btn btn-primary" href="reportes_consultar.html">Ver reportes</a>
          <!-- Agregar: admin (1) y coordinador (2) -->
          <a class="btn btn-accent" href="reportes_agregar.html" data-role-allow="1,2">Crear reporte</a>
          <!-- Editar: 1,2,3 -->
          <a class="btn btn-primary" href="reportes_editar.html" data-role-allow="1,2,3">Editar reportes</a>
          <!-- Usuarios: solo admin -->
          <a class="btn btn-primary" href="usuarios.html" data-role-allow="1">Usuarios</a>
        </div>

        <button id="logout-btn" class="btn btn-outline" style="margin-top:1rem">
          Cerrar sesión
        </button>
      </div>

      <div class="quick-access card">
        <div class="quick-access-header" style="display:flex;gap:12px;justify-content:center;margin-bottom:.5rem">
          <img src="img/urbano.png" alt="Urbano" class="quick-access-logo" />
          <img src="img/logo_city.png" alt="CityReport" class="quick-access-logo" />
        </div>
        <h3 style="text-align:center;font-size:24px">Accesos rápidos</h3>
        <div class="quick-links" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.6rem;margin-top:.6rem">
          <!-- Agregar: admin (1) y coordinador (2) -->
          <a href="reportes_agregar.html" class="quick-link btn btn-accent" data-role-allow="1,2">Agregar Reporte</a>
          <a href="reportes_consultar.html" class="quick-link btn btn-primary">Consultar Reporte</a>
          <!-- Editar: 1,2,3 -->
          <a href="reportes_editar.html" class="quick-link btn btn-primary" data-role-allow="1,2,3">Editar Reporte</a>
          <a href="estadisticas.html" class="quick-link btn btn-primary">Estadísticas</a>
          <!-- Usuarios: solo admin -->
          <a href="usuarios.html" class="quick-link btn btn-primary" data-role-allow="1">Gestión de Usuarios</a>
        </div>
      </div>
    </div>
  </main>

  <footer class="pie">
    <div class="contenedor">&copy; <span id="year"></span> CityReport — Todos los derechos reservados</div>
  </footer>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://ghywlqpirjqsmmlyomaw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoeXdscXBpcmpxc21tbHlvbWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTYwMTYsImV4cCI6MjA3NTM5MjAxNn0.v8fs-lpmWu7cmqM45wKvsFNaHJxcJro4dSxknDWgVGI';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Sesión y permisos por rol =====
    (function roleGate(){
      const raw = sessionStorage.getItem('user');
      if(!raw){ location.href='login.html'; return; }
      let u=null; try{ u=JSON.parse(raw); }catch{}
      if(!u || u.id_rol==null){ location.href='login.html'; return; }

      const role = Number(u.id_rol); // 1 admin, 2 coordinador, 3 supervisor
      document.body.dataset.role = role;

      // Mostrar/ocultar elementos con data-role-allow="1,2,3"
      document.querySelectorAll('[data-role-allow]').forEach(el=>{
        const allow = el.getAttribute('data-role-allow')
          .split(',').map(n=>Number(n.trim()));
        if(!allow.includes(role)){ el.style.display = 'none'; }
      });

      // Saludo
      const h = new Date().getHours();
      let saludo='Buenos días';
      if(h>=12 && h<19) saludo='Buenas tardes';
      else if(h>=19 || h<6) saludo='Buenas noches';
      const name = u.usuario || 'usuario';
      const saludoEl = document.getElementById('saludo');
      if(saludoEl) saludoEl.textContent = `${saludo}, ${name}. Bienvenido al panel de administración de CityReport.`;
    })();

    // ===== Reloj =====
    function updateDateTime(){
      const now = new Date();
      const opts = {weekday:'long',year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'};
      const el = document.getElementById('current-time');
      if(el) el.textContent = now.toLocaleDateString('es-MX', opts);
    }

    // ===== Stats dashboard =====
    async function loadDashboardStats(){
      try{
        const [t,p,r]=await Promise.all([
          supabase.from('reportes').select('*',{count:'exact',head:true}),
          supabase.from('reportes').select('*',{count:'exact',head:true}).eq('estatus','Pendiente'),
          supabase.from('reportes').select('*',{count:'exact',head:true}).eq('estatus','Resuelto'),
        ]);
        document.getElementById('total-reportes').textContent = t.count ?? 0;
        document.getElementById('reportes-pendientes').textContent = p.count ?? 0;
        document.getElementById('reportes-resueltos').textContent = r.count ?? 0;
      }catch(err){
        console.error('Error stats:',err);
      }
    }

    // ===== Logout =====
    function logout(){ sessionStorage.removeItem('user'); location.href='login.html'; }
    document.getElementById('logout-btn')?.addEventListener('click', logout);
    document.getElementById('logout-link')?.addEventListener('click', e=>{ e.preventDefault(); logout(); });

    // Init
    document.getElementById('year').textContent = new Date().getFullYear();
    updateDateTime(); setInterval(updateDateTime, 60000);
    loadDashboardStats();
  </script>
</body>
</html>
