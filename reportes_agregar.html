<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Agregar Reporte - CityReport</title>
  <link rel="stylesheet" href="css/estilos.css">
  <style>
    .panel { max-width: 900px; margin: 32px auto; background: rgba(255,255,255,0.95); padding: 24px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .col { flex:1 1 320px; }
    label{ display:block; font-weight:600; margin-bottom:6px; color:#164a5a }
    input, select, textarea { width:100%; padding:10px; border-radius:8px; border:1px solid #ccc }
    button.primary { background: linear-gradient(90deg,#2E86DE,#54A0FF); color:#fff; padding:10px 16px; border-radius:8px; border:none }
  </style>
</head>
<body>
  <header style="background:linear-gradient(180deg,#114b58,#0f5160);color:#fff;padding:18px 0;">
    <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:0 18px;">
      <div style="display:flex;align-items:center;gap:12px;">
        <a href="index.html"><img src="img/urbano.png" alt="Urbano" style="height:46px"></a>
        <a href="index.html"><img src="img/logo_city.png" alt="CityReport" style="height:44px"></a>
      </div>
      <div style="flex:1;text-align:center">
        <h1 style="margin:0;font-size:26px;">Agregar Reporte</h1>
      </div>
      <nav style="display:flex;gap:12px;align-items:center">
        <a href="index.html" style="color:#dff3ff;text-decoration:none">Inicio</a>
        <a href="reportes_consultar.html" style="color:#dff3ff;text-decoration:none">Reportes</a>
        <a href="estadisticas.html" style="color:#dff3ff;text-decoration:none">Estadísticas</a>
        <a href="#" id="logout-link" style="color:#ffd; text-decoration:none">Cerrar sesión</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="panel">
      <form id="formAdd">
        <div class="row">
          <div class="col">
            <label for="remitente">Remitente</label>
            <input id="remitente" name="remitente" required>

            <label for="clasificacion">Clasificación</label>
            <select id="clasificacion" name="clasificacion" required></select>

            <label for="colonia">Colonia</label>
            <select id="colonia" name="colonia" required></select>
          </div>

          <div class="col">
            <label for="calle">Calle / Referencia</label>
            <input id="calle" name="calle">

            <label for="detalles">Detalles</label>
            <textarea id="detalles" name="detalles" rows="6"></textarea>

            <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
              <button class="primary" type="submit">Agregar Reporte</button>
              <input type="file" id="imagen" accept="image/*">
              <a href="index.html" style="margin-left:auto;text-decoration:none">← Volver</a>
            </div>
          </div>
        </div>
      </form>
      <div id="msg" style="margin-top:12px;color:crimson"></div>
    </div>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://ghywlqpirjqsmmlyomaw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoeXdscXBpcmpxc21tbHlvbWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTYwMTYsImV4cCI6MjA3NTM5MjAxNn0.v8fs-lpmWu7cmqM45wKvsFNaHJxcJro4dSxknDWgVGI';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const form = document.getElementById('formAdd');
  const msg = document.getElementById('msg');
  const fileInput = document.getElementById('imagen');
  const storageBucket = 'reportes-images';

    async function loadOptions() {
      console.log('Cargando opciones...');
      
      // Intentar cargar clasificaciones
      const { data: clas, error: e1 } = await supabase
        .from('clasificaciones')
        .select('*');
      
      console.log('Clasificaciones:', clas, 'Error:', e1);
      
      // Intentar cargar colonias
      const { data: cols, error: e2 } = await supabase
        .from('colonias')
        .select('*');
      
      console.log('Colonias:', cols, 'Error:', e2);
      
      if (e1) { 
        msg.textContent = 'Error cargando clasificaciones: ' + e1.message; 
        console.error('Error clasificaciones:', e1); 
        return; 
      }
      if (e2) { 
        msg.textContent = 'Error cargando colonias: ' + e2.message; 
        console.error('Error colonias:', e2); 
        return; 
      }

      const selC = document.getElementById('clasificacion');
      if (clas && clas.length > 0) {
        selC.innerHTML = '<option value="">Seleccionar...</option>' + 
          clas.map(r => `<option value="${r.id}">${r.nombre}</option>`).join('');
      } else {
        msg.textContent = 'No se encontraron clasificaciones';
        console.log('No hay clasificaciones disponibles');
      }

      const selCol = document.getElementById('colonia');
      if (cols && cols.length > 0) {
        selCol.innerHTML = '<option value="">Seleccionar...</option>' + 
          cols.map(r => `<option value="${r.id}">${r.nombre_colonia}</option>`).join('');
      } else {
        msg.textContent += ' No se encontraron colonias';
        console.log('No hay colonias disponibles');
      }
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msg.textContent = '';
      const remitente = document.getElementById('remitente').value.trim();
      const clasificacion = document.getElementById('clasificacion').value;
      const colonia = document.getElementById('colonia').value;
      const calle = document.getElementById('calle').value.trim();
      const detalles = document.getElementById('detalles').value.trim();

      if (!remitente || !clasificacion || !colonia) { msg.textContent = 'Completa los campos obligatorios'; return; }

      // obtener usuario desde sessionStorage
      const user = JSON.parse(sessionStorage.getItem('user')||'null');
      const registrado_por = user?.usuario || 'anon';

      // intentar upload de imagen si existe
      let imagen_url = null;
      if (fileInput && fileInput.files && fileInput.files[0]) {
        try {
          const f = fileInput.files[0];
          const safeName = f.name.replace(/[^a-z0-9.\-_]/gi,'');
          const filename = `report_${Date.now()}_${safeName}`;
          const { data: upData, error: upErr } = await supabase.storage.from(storageBucket).upload(filename, f, { cacheControl: '3600', upsert: false });
          if (upErr) {
            console.warn('Upload error', upErr);
          } else {
            const { publicURL } = supabase.storage.from(storageBucket).getPublicUrl(upData.path);
            imagen_url = publicURL;
          }
        } catch (err) {
          console.error('Error subiendo imagen:', err);
        }
      }

      const payload = { 
        remitente, 
        id_clasificacion: clasificacion, 
        id_colonia: colonia, 
        calle, 
        detalles, 
        fecha_reporte: new Date().toISOString().slice(0,10), 
        estado: 'Pendiente', 
        id_usuario_creado_por: registrado_por,
        creado_en: new Date().toISOString()
      };
      if (imagen_url) payload.imagen_url = imagen_url;

      let { data, error } = await supabase.from('public.reportes').insert([payload]);
      // si da error por columna imagen_url (o similar) y existe imagen, reintentar sin esa propiedad
      if (error && imagen_url) {
        console.warn('Insert error with imagen_url, retrying without imagen_url', error.message || error);
        const { data: d2, error: e2 } = await supabase.from('reportes').insert([Object.assign({}, payload, { imagen_url: undefined })]);
        data = d2; error = e2;
      }
      if (error) { msg.textContent = 'Error agregando reporte'; console.error(error); return; }
      msg.style.color = 'green'; msg.textContent = 'Reporte agregado correctamente';
      form.reset();
    });

    // check session
    if (!sessionStorage.getItem('user')) window.location.href = 'login.html';
    loadOptions();
  </script>
  <script>
    const logoutLink = document.getElementById('logout-link');
    if (logoutLink) logoutLink.addEventListener('click', (e)=>{ e.preventDefault(); sessionStorage.removeItem('user'); window.location.href='login.html'; });
  </script>
</body>
</html>