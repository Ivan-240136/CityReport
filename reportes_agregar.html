<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Agregar Reporte - CityReport</title>

  <!-- Tema unificado (Azul Petróleo + Naranja Coral) -->
  <link rel="stylesheet" href="css/cityreport-theme.css">
  <link rel="stylesheet" href="css/forms.css">
  <link rel="stylesheet" href="css/tables.css">
  <link rel="stylesheet" href="css/modals.css">
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="header-logo">
        <a href="index.html" class="logo-link header-logos">
          <img src="img/urbano.png" alt="UrbanoTech" class="logo-img logo-urbano">
          <img src="img/logo_city.png" alt="CityReport" class="logo-img logo-city">
        </a>
      </div>

      <div class="header-title">
        <h1 class="title-with-icon">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Agregar Reporte
        </h1>
      </div>

      <nav class="main-nav">
        <a href="index.html" class="nav-link active" aria-current="page"
           style="color:#dff3ff;text-decoration:none;display:flex;align-items:center;gap:4px;font-weight:700">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
          </svg>
          Inicio
        </a>
        <a href="reportes_consultar.html" class="nav-link"
           style="color:#dff3ff;text-decoration:none;display:flex;align-items:center;gap:4px">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
          </svg>
          Reportes
        </a>
        <a href="estadisticas.html" class="nav-link"
           style="color:#dff3ff;text-decoration:none;display:flex;align-items:center;gap:4px">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          Estadísticas
        </a>
        <!-- Solo admin -->
        <a href="usuarios.html" class="nav-link" data-role-allow="1" style="color:#dff3ff;text-decoration:none;display:flex;align-items:center;gap:4px"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px"><path d="M17 20h5v-2a4 4 0 00-5-3.87M9 20H4v-2a4 4 0 0 1 5-3.87M12 12a4 4 0 100-8 4 4 0 000 8z"/></svg>Usuarios</a>

        <a href="#" id="logout-link" style="color:#ffd;text-decoration:none;display:flex;align-items:center;gap:4px">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          Usuarios
        </a>
        <a href="#" id="logout-link" class="nav-link">Cerrar sesión</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="panel card">
      <div id="forbiddenMsg" class="alert warn" style="display:none">
        Tu rol no tiene permiso para agregar reportes. Serás redirigido al inicio.
      </div>

      <div class="mb-16">
        <a href="index.html" class="btn btn-primary">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10 19l-7-7 7-7M3 12h18"/>
          </svg>
          Volver
        </a>
      </div>

      <form id="formAdd" class="animate-slide-in">
        <div class="form-grid">
          <div class="form-group">
            <label for="remitente">Remitente <span class="text-danger">*</span></label>
            <input id="remitente" name="remitente" class="form-control" required placeholder="Nombre completo del remitente">
          </div>

          <div class="form-group">
            <label for="clasificacion">Clasificación <span class="text-danger">*</span></label>
            <select id="clasificacion" name="clasificacion" class="form-control" required>
              <option value="">Seleccionar clasificación...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="colonia">Colonia <span class="text-danger">*</span></label>
            <select id="colonia" name="colonia" class="form-control" required>
              <option value="">Seleccionar colonia...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="calle">Calle / Referencia</label>
            <input id="calle" name="calle" class="form-control" placeholder="Dirección o punto de referencia">
          </div>

          <div class="form-group full">
            <label for="detalles">Detalles del reporte</label>
            <textarea id="detalles" name="detalles" class="form-control" rows="6" placeholder="Describe los detalles del reporte..."></textarea>
          </div>

          <input type="file" id="imagen" accept="image/*" hidden>

          <div class="form-group full">
            <div class="flex-between">
              <button type="submit" class="btn btn-primary">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
                Agregar Reporte
              </button>
              <span class="muted">(La subida de imágenes llegará más adelante)</span>
            </div>
          </div>
        </div>
      </form>

      <div id="msg" class="mt-12"></div>
    </div>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://ghywlqpirjqsmmlyomaw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoeXdscXBpcmpxc21tbHlvbWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTYwMTYsImV4cCI6MjA3NTM5MjAxNn0.v8fs-lpmWu7cmqM45wKvsFNaHJxcJro4dSxknDWgVGI';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Sesión y roles =====
    const allowedRoles = [1, 2]; // Admin, Coordinador
    const raw = sessionStorage.getItem('user');
    if (!raw) location.href = 'login.html';

    let currentUser = null;
    try { currentUser = JSON.parse(raw); } catch {}
    const role = Number(currentUser?.id_rol);

    // Mostrar/ocultar enlaces por rol
    document.querySelectorAll('[data-role-allow]').forEach(el=>{
      const allow = el.getAttribute('data-role-allow').split(',').map(n=>Number(n.trim()));
      if(!allow.includes(role)) el.style.display = 'none';
    });

    const form = document.getElementById('formAdd');
    const msg = document.getElementById('msg');
    const forbiddenMsg = document.getElementById('forbiddenMsg');

    function blockAccess(){
      forbiddenMsg.style.display = 'block';
      form.querySelectorAll('input,select,textarea,button').forEach(el=>el.disabled=true);
      setTimeout(()=>location.href='index.html', 1500);
    }
    if (!allowedRoles.includes(role)) blockAccess();

    // ===== Combos =====
    async function loadOptions(){
      if (!allowedRoles.includes(role)) return;
      const selC = document.getElementById('clasificacion');
      const selCol = document.getElementById('colonia');
      try{
        const [clasResult, colResult] = await Promise.all([
          supabase.from('clasificaciones').select('id,nombre').order('nombre'),
          supabase.from('colonias').select('id,nombre_colonia').order('nombre_colonia')
        ]);
        if (clasResult.error) throw clasResult.error;
        if (colResult.error) throw colResult.error;

        selC.innerHTML = `<option value="">Seleccionar clasificación...</option>${
          (clasResult.data||[]).map(r=>`<option value="${r.id}">${r.nombre}</option>`).join('')
        }`;
        selCol.innerHTML = `<option value="">Seleccionar colonia...</option>${
          (colResult.data||[]).map(r=>`<option value="${r.id}">${r.nombre_colonia}</option>`).join('')
        }`;

        msg.textContent = '';
        document.getElementById('remitente')?.focus();
      }catch(error){
        msg.className='alert error';
        msg.textContent = error.message || 'Error cargando datos';
        form.querySelectorAll('input,select,button,textarea').forEach(el=>el.disabled=true);
      }
    }

    // ===== Submit =====
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!allowedRoles.includes(role)) { blockAccess(); return; }

      msg.className=''; msg.textContent='';
      const remitente = document.getElementById('remitente').value.trim();
      const clasificacion = document.getElementById('clasificacion').value;
      const colonia = document.getElementById('colonia').value;
      const calle = document.getElementById('calle').value.trim();
      const detalles = document.getElementById('detalles').value.trim();

      if(!remitente || !clasificacion || !colonia){
        msg.className='alert error'; msg.textContent='Completa los campos obligatorios'; return;
      }

      const btn = form.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent = 'Agregando…';

      try{
        const now = new Date().toISOString().replace('T',' ').substring(0,19);
        const payload = {
          remitente,
          id_clasificacion: parseInt(clasificacion),
          id_colonia: parseInt(colonia),
          calle,
          detalles,
          fecha_reporte: now,
          estatus: 'Pendiente',
          creado_por: currentUser?.id || null,
          creado_en: now
        };

        const { error } = await supabase.from('reportes').insert([payload]);
        if (error) throw error;

        msg.className='alert ok';
        msg.textContent='¡Reporte agregado correctamente!';
        form.reset();
        setTimeout(()=>location.href='reportes_consultar.html', 1200);
      }catch(error){
        msg.className='alert error';
        msg.textContent=`Error al agregar reporte: ${error.message||'Desconocido'}`;
      }finally{
        btn.disabled=false; btn.textContent='Agregar Reporte';
      }
    });

    if (allowedRoles.includes(role)) loadOptions();

    // Logout
    document.getElementById('logout-link')?.addEventListener('click', e=>{
      e.preventDefault(); sessionStorage.removeItem('user'); location.href='login.html';
    });
  </script>
</body>
</html>
