<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Agregar Reporte - CityReport</title>
  <link rel="stylesheet" href="css/estilos.css">
  <style>
    .panel { max-width: 900px; margin: 32px auto; background: rgba(255,255,255,0.98); padding: 24px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:start}
    .full{grid-column:1 / -1}
    @media (max-width:820px){ .form-grid{grid-template-columns:1fr} }
    label{ display:block; font-weight:600; margin-bottom:6px; color:#164a5a }
    input, select, textarea { width:100%; padding:10px; border-radius:8px; border:1px solid #e6f0f6; background:#fbfdff }
    button.primary { background: linear-gradient(90deg,#0d6efd,#3aa0ff); color:#fff; padding:10px 16px; border-radius:8px; border:none; box-shadow:0 6px 18px rgba(13,110,253,0.12) }
    .muted { color:#6b7b84; font-size:13px }
    .hint { font-size:12px;color:#6b7b84;margin-top:6px }
  </style>
</head>
<body>
  <header style="background:linear-gradient(180deg,#114b58,#0f5160);color:#fff;padding:18px 0;">
    <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:0 18px;">
      <div style="display:flex;align-items:center;gap:12px;">
        <a href="index.html"><img src="img/urbano.png" alt="Urbano" style="height:46px"></a>
        <a href="index.html"><img src="img/logo_city.png" alt="CityReport" style="height:44px"></a>
      </div>
      <div style="flex:1;text-align:center">
        <h1 style="margin:0;font-size:26px;">Agregar Reporte</h1>
      </div>
      <nav style="display:flex;gap:12px;align-items:center">
        <a href="index.html" style="color:#dff3ff;text-decoration:none">Inicio</a>
        <a href="reportes_consultar.html" style="color:#dff3ff;text-decoration:none">Reportes</a>
        <a href="estadisticas.html" style="color:#dff3ff;text-decoration:none">Estadísticas</a>
        <a href="#" id="logout-link" style="color:#ffd; text-decoration:none">Cerrar sesión</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="panel">
      <form id="formAdd">
        <div class="row">
          <div class="col">
            <label for="remitente">Remitente</label>
            <input id="remitente" name="remitente" required>

            <label for="clasificacion">Clasificación</label>
            <select id="clasificacion" name="clasificacion" required></select>

            <label for="colonia">Colonia</label>
            <select id="colonia" name="colonia" required></select>
          </div>

          <div class="col">
            <label for="calle">Calle / Referencia</label>
            <input id="calle" name="calle">

            <label for="detalles">Detalles</label>
            <textarea id="detalles" name="detalles" rows="6"></textarea>

            <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
                  <button class="primary" type="submit">Agregar Reporte</button>
                  <span class="hint">(Subida de imágenes: se implementará más adelante)</span>
                  <!-- Mantener input oculto para futuro uso pero no activo -->
                  <input type="file" id="imagen" accept="image/*" style="display:none">
                  <a href="index.html" style="margin-left:auto;text-decoration:none">← Volver</a>
                </div>
          </div>
        </div>
      </form>
      <div id="msg" style="margin-top:12px;color:crimson"></div>
    </div>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://ghywlqpirjqsmmlyomaw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoeXdscXBpcmpxc21tbHlvbWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTYwMTYsImV4cCI6MjA3NTM5MjAxNn0.v8fs-lpmWu7cmqM45wKvsFNaHJxcJro4dSxknDWgVGI';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const form = document.getElementById('formAdd');
  const msg = document.getElementById('msg');
  const fileInput = document.getElementById('imagen');
  const storageBucket = 'reportes-images';

  async function loadOptions() {
      const selC = document.getElementById('clasificacion');
      const selCol = document.getElementById('colonia');
      
      try {
        // Cargar clasificaciones y colonias en paralelo
        const [clasResult, colResult] = await Promise.all([
          supabase.from('clasificaciones')
            .select('id, nombre')
            .order('nombre'),
          supabase.from('colonias')
            .select('id, nombre_colonia')
            .order('nombre_colonia')
        ]);

        // Manejar errores
        if (clasResult.error) throw new Error(`Error cargando clasificaciones: ${clasResult.error.message}`);
        if (colResult.error) throw new Error(`Error cargando colonias: ${colResult.error.message}`);

        // Validar datos
        if (!clasResult.data?.length) throw new Error('No hay clasificaciones disponibles');
        if (!colResult.data?.length) throw new Error('No hay colonias disponibles');

        // Actualizar selects
        selC.innerHTML = `
          <option value="">Seleccionar clasificación...</option>
          ${clasResult.data.map(r => 
            `<option value="${r.id}">${r.nombre}</option>`
          ).join('')}
        `;

        selCol.innerHTML = `
          <option value="">Seleccionar colonia...</option>
          ${colResult.data.map(r => 
            `<option value="${r.id}">${r.nombre_colonia}</option>`
          ).join('')}
        `;

  // Limpiar mensajes de error previos
  msg.textContent = '';

  // focus inicial en remitente para mejor UX
  const r = document.getElementById('remitente'); if(r) r.focus();

      } catch (error) {
        console.error('Error cargando opciones:', error);
        msg.style.color = '#721c24';
        msg.style.backgroundColor = '#f8d7da';
        msg.style.padding = '10px';
        msg.style.borderRadius = '4px';
        msg.textContent = error.message || 'Error cargando datos';
        
        // Deshabilitar el formulario si no se pueden cargar las opciones
        form.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
      }
    }

    // Validar archivo de imagen
    function validateImage(file) {
      const maxSize = 5 * 1024 * 1024; // 5MB
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      
      if (!allowedTypes.includes(file.type)) {
        throw new Error('Solo se permiten imágenes en formato JPG, PNG, GIF o WEBP');
      }
      
      if (file.size > maxSize) {
        throw new Error('La imagen no debe exceder 5MB');
      }
      
      return true;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msg.textContent = '';
      const remitente = document.getElementById('remitente').value.trim();
      const clasificacion = document.getElementById('clasificacion').value;
      const colonia = document.getElementById('colonia').value;
      const calle = document.getElementById('calle').value.trim();
      const detalles = document.getElementById('detalles').value.trim();

      // Nota: la subida de imágenes la gestionaremos más adelante.
      // Por ahora ignoramos cualquier archivo seleccionado y continuamos con el registro.

  if (!remitente || !clasificacion || !colonia) { msg.textContent = 'Completa los campos obligatorios'; return; }

      // obtener usuario desde sessionStorage
      const user = JSON.parse(sessionStorage.getItem('user')||'null');
      const registrado_por = user?.usuario || 'anon';

  // Por ahora no subimos la imagen desde el cliente. imagen_url queda null.
  let imagen_url = null;

      // Deshabilitar botón y mostrar estado
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Agregando...';
      msg.textContent = '';

      try {
        const now = new Date().toISOString().replace('T', ' ').substring(0, 19);
        const payload = {
          remitente,
          id_clasificacion: parseInt(clasificacion),
          id_colonia: parseInt(colonia),
          calle,
          detalles,
          fecha_reporte: now, // legacy / compat
          estatus: 'Pendiente',
          creado_por: user?.id || null,
          creado_en: now
        };

        if (imagen_url) {
          payload.imagen_url = imagen_url;
        }

        console.log('Insertando reporte con payload:', payload);

        const { data, error } = await supabase
          .from('reportes')
          .insert([payload])
          .select()
          .single();

        if (error) throw error;

        console.log('Reporte agregado exitosamente:', data);
        msg.style.color = '#155724';
        msg.style.backgroundColor = '#d4edda';
        msg.style.padding = '10px';
        msg.style.borderRadius = '4px';
        msg.textContent = '¡Reporte agregado correctamente!';
        
        // Limpiar formulario
        form.reset();
        
        // Redirigir después de 2 segundos
        setTimeout(() => {
          window.location.href = 'reportes_consultar.html';
        }, 2000);

      } catch (error) {
        console.error('Error al agregar reporte:', error);
        msg.style.color = '#721c24';
        msg.style.backgroundColor = '#f8d7da';
        msg.style.padding = '10px';
        msg.style.borderRadius = '4px';
        msg.textContent = `Error al agregar reporte: ${error.message || 'Error desconocido'}`;
      } finally {
        // Restaurar botón
        submitBtn.disabled = false;
        submitBtn.textContent = 'Agregar Reporte';
      }
      // (no reset global aquí; ya se hace en éxito)
    });

    // check session
    if (!sessionStorage.getItem('user')) window.location.href = 'login.html';
    
    // Verificar esquema de la tabla
    async function checkSchema() {
      try {
        console.log('Verificando esquema de la tabla reportes...');
        const { data, error } = await supabase
          .from('reportes')
          .select()
          .limit(1);
        
        if (error) throw error;
        
        if (data && data[0]) {
          console.log('Columnas disponibles en la tabla reportes:', Object.keys(data[0]));
        }
      } catch (err) {
        console.error('Error al verificar esquema:', err);
      }
    }
    
    loadOptions();
    checkSchema();
  </script>
  <script>
    const logoutLink = document.getElementById('logout-link');
    if (logoutLink) logoutLink.addEventListener('click', (e)=>{ e.preventDefault(); sessionStorage.removeItem('user'); window.location.href='login.html'; });
  </script>
</body>
</html>