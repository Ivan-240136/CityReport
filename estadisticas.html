<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Estadísticas - CityReport</title>
  <link rel="stylesheet" href="css/estilos.css">
  <link rel="stylesheet" href="css/forms.css">
  <link rel="stylesheet" href="css/tables.css">
  <link rel="stylesheet" href="css/modals.css">
  <link rel="stylesheet" href="css/stats.css">
  <link rel="stylesheet" href="css/nav.css">
</head>
<body>
  <header class="main-header">
    <div class="header-container">
      <div class="logo-container">
        <a href="index.html" class="logo-link">
          <img src="img/urbano.png" alt="Urbano" class="logo-img">
          <img src="img/logo_city.png" alt="City Report" class="logo-img">
        </a>
      </div>
      <h1 class="header-title">Estadísticas</h1>
      <nav class="main-nav">
        <a href="index.html" class="nav-link">
          <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
          </svg>
          <span>Inicio</span>
        </a>
        <a href="reportes_consultar.html" class="nav-link">
          <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
          </svg>
          <span>Reportes</span>
        </a>
        <a href="estadisticas.html" class="nav-link active">
          <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          <span>Estadísticas</span>
        </a>
        <a href="#" id="logout-link" class="nav-link">
          <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          <span>Cerrar sesión</span>
        </a>
      </nav>
    </div>
  </header>

  <main>
    <div class="stats-container">
      <div class="stats-header">
        <div class="stats-header-content">
          <div id="dateNow" class="stats-date"></div>
          <h2 class="stats-title">Panel de Estadísticas</h2>
        </div>
        <a href="index.html" class="btn btn-ghost">
          <svg class="icon-stats" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Volver
        </a>
      </div>

      <div class="stats-cards">
        <div class="stat-card total">
          <span class="stat-label">Total de Reportes</span>
          <p class="stat-value animate-count" id="totalVal">0</p>
        </div>
        <div class="stat-card pending">
          <span class="stat-label">Pendientes</span>
          <p class="stat-value animate-count" id="pendVal">0</p>
        </div>
        <div class="stat-card in-progress">
          <span class="stat-label">En Proceso</span>
          <p class="stat-value animate-count" id="procVal">0</p>
        </div>
        <div class="stat-card completed">
          <span class="stat-label">Resueltos</span>
          <p class="stat-value animate-count" id="resVal">0</p>
        </div>
      </div>

      <div class="stats-grid">
        <div class="info-card">
          <p class="info-value" id="coloniaFreq">—</p>
          <p class="info-label">Colonia más frecuente</p>
        </div>
        <div class="info-card">
          <p class="info-value" id="clasificacionFreq">—</p>
          <p class="info-label">Reporte más común</p>
        </div>
        <div class="info-card">
          <p class="info-value" id="picoDia">—</p>
          <p class="info-label">Pico de actividad semanal</p>
        </div>
        <div class="info-card">
          <p class="info-value" id="tasaRes">—</p>
          <p class="info-label">Tasa De Resolución General</p>
        </div>
      </div>

    </div>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://ghywlqpirjqsmmlyomaw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoeXdscXBpcmpxc21tbHlvbWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTYwMTYsImV4cCI6MjA3NTM5MjAxNn0.v8fs-lpmWu7cmqM45wKvsFNaHJxcJro4dSxknDWgVGI';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    if (!sessionStorage.getItem('user')) window.location.href='login.html';

    document.getElementById('dateNow').textContent = new Date().toLocaleString();

    async function loadStats(){
      const { data: total } = await supabase.from('reportes').select('id', { count: 'exact' });
      const { data: pend } = await supabase.from('reportes').select('id', { count: 'exact' }).eq('estado','Pendiente');
      const { data: proc } = await supabase.from('reportes').select('id', { count: 'exact' }).eq('estado','En Proceso');
      const { data: res } = await supabase.from('reportes').select('id', { count: 'exact' }).eq('estado','Resuelto');
      document.getElementById('totalVal').textContent = total?.length || 0;
      document.getElementById('pendVal').textContent = pend?.length || 0;
      document.getElementById('procVal').textContent = proc?.length || 0;
      document.getElementById('resVal').textContent = res?.length || 0;

      // colonia mas frecuente
      const { data: byCol } = await supabase.from('reportes').select('colonia_id, count:id').group('colonia_id').order('count', {ascending:false}).limit(1);
      if (byCol && byCol.length) {
        const { data: colName } = await supabase.from('colonias').select('nombre_colonia').eq('id', byCol[0].colonia_id).single();
        document.getElementById('coloniaFreq').textContent = colName?.nombre_colonia || '—';
      }

      // clasificacion mas comun
      const { data: byClas } = await supabase.from('reportes').select('clasificacion_id, count:id').group('clasificacion_id').order('count', {ascending:false}).limit(1);
      if (byClas && byClas.length) {
        const { data: cName } = await supabase.from('clasificaciones').select('nombre').eq('id', byClas[0].clasificacion_id).single();
        document.getElementById('clasificacionFreq').textContent = cName?.nombre || '—';
      }

      // pico semanal: dia de la semana con mas reportes (0-6)
      const { data: days } = await supabase.rpc('reportes_dia_semana');
      if (days && days.length) document.getElementById('picoDia').textContent = days[0].dia || '—';

      // tasa resolucion
      const totalCount = total?.length||0; const resCount = res?.length||0;
      document.getElementById('tasaRes').textContent = totalCount? Math.round((resCount/totalCount)*100) + '%' : '0%';
    }

    loadStats();
  </script>
  <script>
    const logoutLink = document.getElementById('logout-link');
    if (logoutLink) logoutLink.addEventListener('click', (e)=>{ e.preventDefault(); sessionStorage.removeItem('user'); window.location.href='login.html'; });
  </script>
</body>
</html>