<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Estadísticas - CityReport</title>
  <link rel="stylesheet" href="css/estilos.css">
  <link rel="stylesheet" href="css/forms.css">
  <link rel="stylesheet" href="css/tables.css">
  <link rel="stylesheet" href="css/modals.css">
  <link rel="stylesheet" href="css/stats.css">
  <link rel="stylesheet" href="css/nav.css">
  <script src="js/statsAnimation.js" defer></script>
</head>
<body>
  <header class="main-header">
    <div class="header-container">
      <div class="logo-container">
        <a href="index.html" class="logo-link" style="display:flex;align-items:center;gap:12px;">
          <img src="img/urbano.png" alt="Urbano" style="height:140px;background:white;padding:10px;border-radius:10px;transition:transform 0.2s ease;box-shadow:0 3px 6px rgba(0,0,0,0.15)">
          <img src="img/logo_city.png" alt="CityReport" style="height:138px;background:white;padding:10px;border-radius:10px;transition:transform 0.2s ease;box-shadow:0 3px 6px rgba(0,0,0,0.15)">
        </a>
      </div>
      <h1 class="header-title">Estadísticas</h1>
      <nav class="main-nav">
        <a href="index.html" class="nav-link">
          <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
          </svg>
          <span>Inicio</span>
        </a>
        <a href="reportes_consultar.html" class="nav-link">
          <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
          </svg>
          <span>Reportes</span>
        </a>
        <a href="estadisticas.html" class="nav-link active">
          <svg class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          <span>Estadísticas</span>
        </a>
        <a href="#" id="logout-link" style="color:#ffd;text-decoration:none;display:flex;align-items:center;gap:4px">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          <span>Cerrar sesión</span>
        </a>
      </nav>
    </div>
  </header>

  <main>
    <div class="content-panel">
      <div class="panel-header">
        <div class="panel-title">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          Panel de Estadísticas
        </div>
        <div class="action-buttons">
          <span class="stats-date" id="dateNow"></span>
          <a href="index.html" class="btn btn-primary btn-hover-lift">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
            Inicio
          </a>
        </div>
      </div>

      <div class="stats-cards animate-slide-in">
        <div class="stat-card data-card total">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          <span class="stat-label">Total de Reportes</span>
          <p class="stat-value animate-count" id="totalVal">0</p>
        </div>
        <div class="stat-card data-card pending">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="stat-label">Pendientes</span>
          <p class="stat-value animate-count" id="pendVal">0</p>
        </div>
        <div class="stat-card data-card in-progress">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
          </svg>
          <span class="stat-label">En Proceso</span>
          <p class="stat-value animate-count" id="procVal">0</p>
        </div>
        <div class="stat-card data-card completed">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="stat-label">Resueltos</span>
          <p class="stat-value animate-count" id="resVal">0</p>
        </div>
      </div>

      <div class="stats-grid">
        <div class="info-card data-card">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <p class="info-value" id="coloniaFreq">—</p>
          <p class="info-label">Colonia más frecuente</p>
        </div>
        <div class="info-card data-card">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          <p class="info-value" id="clasificacionFreq">—</p>
          <p class="info-label">Reporte más común</p>
        </div>
        <div class="info-card data-card">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          <p class="info-value" id="picoDia">—</p>
          <p class="info-label">Pico de actividad semanal</p>
        </div>
        <div class="info-card data-card">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <p class="info-value" id="tasaRes">—</p>
          <p class="info-label">Tasa De Resolución General</p>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://ghywlqpirjqsmmlyomaw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoeXdscXBpcmpxc21tbHlvbWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTYwMTYsImV4cCI6MjA3NTM5MjAxNn0.v8fs-lpmWu7cmqM45wKvsFNaHJxcJro4dSxknDWgVGI';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    if (!sessionStorage.getItem('user')) window.location.href='login.html';

    document.getElementById('dateNow').textContent = new Date().toLocaleString();

    async function loadStats(){
      // Contadores principales (usamos count retornado por Supabase cuando es posible)
      const { data: totalData, count: totalCount, error: totalError } = await supabase.from('reportes').select('id', { count: 'exact' });
      const { data: pendData, count: pendCount, error: pendError } = await supabase.from('reportes').select('id', { count: 'exact' }).eq('estado','Pendiente');
      const { data: procData, count: procCount, error: procError } = await supabase.from('reportes').select('id', { count: 'exact' }).eq('estado','En Proceso');
      const { data: resData, count: resCount, error: resError } = await supabase.from('reportes').select('id', { count: 'exact' }).eq('estado','Resuelto');

      // Log para depuración en consola
      if (totalError || pendError || procError || resError) {
        console.error('Errores en conteos:', { totalError, pendError, procError, resError });
      }

      const totalNum = (typeof totalCount === 'number') ? totalCount : (totalData ? totalData.length : 0);
      const pendNum = (typeof pendCount === 'number') ? pendCount : (pendData ? pendData.length : 0);
      const procNum = (typeof procCount === 'number') ? procCount : (procData ? procData.length : 0);
      const resNum = (typeof resCount === 'number') ? resCount : (resData ? resData.length : 0);

      // helper: animate if available
      function setAnimatedValue(elId, value){
        const el = document.getElementById(elId);
        if(!el) return;
        if(typeof window.animateValue === 'function'){
          // ensure number
          window.animateValue(el, 0, Number(value||0), 1200);
        } else {
          el.textContent = value;
        }
      }

      setAnimatedValue('totalVal', totalNum);
      setAnimatedValue('pendVal', pendNum);
      setAnimatedValue('procVal', procNum);
      setAnimatedValue('resVal', resNum);

  // Traer IDs relevantes (colonia, clasificacion, created_at) y agregar en cliente
  // NOTA: si hay muchos reportes, puede ser preferible una consulta server-side/RPC.
  const { data: reports, error: reportsError } = await supabase.from('reportes').select('colonia_id,clasificacion_id,created_at').limit(10000);
  if (reportsError) console.error('Error al obtener reportes:', reportsError);
  console.debug('Reports fetched:', reports ? reports.length : 0, reportsError || 'ok');

      // valores por defecto
      document.getElementById('coloniaFreq').textContent = '—';
      document.getElementById('clasificacionFreq').textContent = '—';
      document.getElementById('picoDia').textContent = '—';

      if (reports && reports.length){
        const colCount = {};
        const clasCount = {};
        const dayCount = {};

        reports.forEach(r => {
          if (r.colonia_id) colCount[r.colonia_id] = (colCount[r.colonia_id] || 0) + 1;
          if (r.clasificacion_id) clasCount[r.clasificacion_id] = (clasCount[r.clasificacion_id] || 0) + 1;
          if (r.created_at){
            const d = new Date(r.created_at).getDay();
            dayCount[d] = (dayCount[d] || 0) + 1;
          }
        });

        console.debug('colCount sample:', colCount);
        console.debug('clasCount sample:', clasCount);
        console.debug('dayCount sample:', dayCount);

        // Top colonia
        const topCol = Object.entries(colCount).sort((a,b)=>b[1]-a[1])[0];
        if (topCol){
          const [colId, cnt] = topCol;
          const { data: col, error: colError } = await supabase.from('colonias').select('nombre_colonia').eq('id', colId).limit(1).single();
          if (colError) console.warn('No se pudo obtener nombre de colonia', colError, 'colId=', colId);
          document.getElementById('coloniaFreq').textContent = `${col?.nombre_colonia || '—'} (${cnt} reportes)`;
        }

        // Top clasificacion
        const topClas = Object.entries(clasCount).sort((a,b)=>b[1]-a[1])[0];
        if (topClas){
          const [clasId, cnt] = topClas;
          const { data: cl, error: clError } = await supabase.from('clasificaciones').select('nombre').eq('id', clasId).limit(1).single();
          if (clError) console.warn('No se pudo obtener nombre de clasificacion', clError, 'clasId=', clasId);
          document.getElementById('clasificacionFreq').textContent = `${cl?.nombre || '—'} (${cnt} reportes)`;
        }

        // Pico semanal
        const diasSemana = ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
        const topDay = Object.entries(dayCount).sort((a,b)=>b[1]-a[1])[0];
        if (topDay){
          document.getElementById('picoDia').textContent = `${diasSemana[Number(topDay[0])] } (${topDay[1]} reportes)`;
        }
      }

      // Tasa de resolucion (resueltos / total)
      const tasa = totalNum ? Math.round((resNum/totalNum)*100) : 0;
      document.getElementById('tasaRes').textContent = `${tasa}% (${resNum}/${totalNum})`;
    }

    loadStats();
  </script>
  <script>
    const logoutLink = document.getElementById('logout-link');
    if (logoutLink) logoutLink.addEventListener('click', (e)=>{ e.preventDefault(); sessionStorage.removeItem('user'); window.location.href='login.html'; });
  </script>
</body>
</html>