<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iniciar sesión - CityReport</title>
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="css/cityreport-theme.css" />
  <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
</head>
<body class="login-page">
  <canvas class="particles"></canvas>

  <div class="container">
    <div class="logo-wrapper">
      <div class="logo-side"><img src="img/urbano.png" alt="Logo Urbano" /></div>
      <div class="logo-side"><img src="img/logo_city.png" alt="CityReport" /></div>
    </div>
    <h2>CityReport</h2>
    <p class="welcome">¡Bienvenido! Por favor, inicia sesión para continuar.</p>

    <div id="alert" class="error"></div>

    <form id="login-form" autocomplete="off">
      <label for="usuario">Nombre de Usuario</label>
      <input id="usuario" name="usuario" type="text" placeholder="Ingresa tu usuario" required />
      <label for="contrasena">Contraseña</label>
      <input id="contrasena" name="contrasena" type="password" placeholder="Ingresa tu contraseña" required />
      <button type="submit">Iniciar Sesión</button>
    </form>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://ghywlqpirjqsmmlyomaw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoeXdscXBpcmpxc21tbHlvbWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTYwMTYsImV4cCI6MjA3NTM5MjAxNn0.v8fs-lpmWu7cmqM45wKvsFNaHJxcJro4dSxknDWgVGI';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const bcrypt = window.dcodeIO?.bcrypt;

    const form = document.getElementById('login-form');
    const alertEl = document.getElementById('alert');

    // Fondo particles
    (function particles() {
      const c = document.querySelector('.particles'); if (!c) return;
      const ctx = c.getContext('2d'); let w = innerWidth, h = innerHeight; c.width = w; c.height = h;
      const ps = Array.from({length: 35}, () => ({
        x:Math.random()*w,
        y:Math.random()*h,
        r:2+Math.random()*2,
        dx:-.3+Math.random()*.6,
        dy:-.3+Math.random()*.6,
        o:.1+Math.random()*.2
      }));
      const draw = () => {
        ctx.clearRect(0,0,w,h);
        for(const p of ps){
          ctx.beginPath();
          ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
          ctx.fillStyle=`rgba(84,160,255,${p.o})`;
          ctx.fill();
          p.x+=p.dx; p.y+=p.dy;
          if(p.x<0) p.x=w;
          if(p.x>w) p.x=0;
          if(p.y<0) p.y=h;
          if(p.y>h) p.y=0;
        }
        requestAnimationFrame(draw);
      };
      draw();
      addEventListener('resize',()=>{
        w=innerWidth; h=innerHeight; c.width=w; c.height=h;
      });
    })();

    const showError = (msg) => {
      alertEl.textContent = msg;
      alertEl.style.display = 'block';
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      alertEl.style.display = 'none';

      const usuario = document.getElementById('usuario').value.trim();
      const contrasena = document.getElementById('contrasena').value;

      if (!usuario || !contrasena) return showError('Completa usuario y contraseña.');
      if (!bcrypt) return showError('No se pudo cargar el verificador de contraseñas.');

      try {
        const { data: user, error } = await supabase
          .from('usuarios')
          .select('id, usuario, contrasena, id_rol, estado')
          .eq('usuario', usuario)
          .limit(1)
          .single();

        if (error || !user) return showError('Usuario o contraseña incorrectos.');

        const ok = bcrypt.compareSync(contrasena, user.contrasena || '');
        if (!ok) return showError('Usuario o contraseña incorrectos.');

        // ===== Validación de estado =====
        const activo = (user.estado === null || user.estado === undefined) ? true : !!user.estado;
        if (!activo) {
          return showError('Tu cuenta está inhabilitada. Contacta al administrador del sistema.');
        }

        // ===== Login correcto y cuenta activa =====
        sessionStorage.setItem('user', JSON.stringify({
          id: user.id,
          usuario: user.usuario,
          id_rol: user.id_rol
        }));
        window.location.href = 'index.html';
      } catch (err) {
        console.error(err);
        showError('Error al intentar iniciar sesión.');
      }
    });
  </script>
</body>
</html>
