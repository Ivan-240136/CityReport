<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Consultar Reportes - CityReport</title>
  <link rel="stylesheet" href="css/estilos.css">
  <link rel="stylesheet" href="css/forms.css">
  <link rel="stylesheet" href="css/tables.css">
  <link rel="stylesheet" href="css/modals.css">
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="header-logo">
        <a href="index.html" class="logo-link">
          <img src="img/urbano.png" alt="Urbano" class="logo-img">
          <img src="img/logo_city.png" alt="CityReport" class="logo-img">
        </a>
      </div>
      <div class="header-title">
        <h1>
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
          </svg>
          Consultar Reportes
        </h1>
      </div>
      <nav class="header-nav">
        <a href="index.html" class="nav-link">
          <svg class="icon small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
          </svg>
          Inicio
        </a>
        <a href="reportes_consultar.html" class="nav-link active">
          <svg class="icon small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
          </svg>
          Reportes
        </a>
        <a href="estadisticas.html" class="nav-link">
          <svg class="icon small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          Estadísticas
        </a>
        <a href="#" id="logout-link" class="nav-link nav-link-logout">
          <svg class="icon small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          Cerrar sesión
        </a>
      </nav>
    </div>
  </header>

  <main>
    <div class="panel">
      <div class="panel-header">
        <a href="index.html" class="btn btn-secondary btn-back animate-slide-in">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Volver
        </a>
      </div>

      <div class="search-bar animate-slide-in" style="margin-top: 1rem">
        <div class="search-input-group">
          <input id="q" class="form-control search-input" 
                 placeholder="Buscar por ID o remitente..." 
                 aria-label="Buscar reportes">
          <button id="btnSearch" class="btn btn-primary">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            Buscar
          </button>
          <a href="reportes_agregar.html" class="btn btn-secondary">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 4v16m8-8H4"/>
            </svg>
            Agregar reporte
          </a>
        </div>
      </div>

      <div id="list-container" class="loading-overlay">
        <div id="list"></div>
        <!-- Overlay de carga -->
        <div id="loading" class="loading" aria-hidden="true" style="display:none">
          <div style="text-align:center">
            <div class="spinner" role="status" aria-hidden="true"></div>
            <div style="margin-top:8px;color:#123; font-weight:600">Cargando reportes…</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal para detalles del reporte -->
  <div id="reporteModal" class="modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2 style="margin:0">Detalles del Reporte</h2>
        <button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer;padding:4px 8px">&times;</button>
      </div>
      <div id="reporteDetails"></div>
    </div>
  </div>

  <!-- Modal para previsualización de imagen -->
  <div id="imageModal" class="modal" onclick="this.classList.remove('show')" style="background:rgba(0,0,0,0.9)">
    <div style="height:100%;display:flex;align-items:center;justify-content:center">
      <img id="modalImage" style="max-width:90%;max-height:90%;object-fit:contain;border-radius:8px" src="" alt="Previsualización">
    </div>
  </div>

  <script>
    function showReporteDetails(reporte) {
      const modal = document.getElementById('reporteModal');
      const details = document.getElementById('reporteDetails');
      
      const fechaCreacion = reporte.creado_en ? new Date(reporte.creado_en).toLocaleDateString('es-MX', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }) : 'N/A';

      const fechaActualizado = reporte.updated_at ? new Date(reporte.updated_at).toLocaleDateString('es-MX', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }) : null;

      details.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px">
          <div>
            <h3 style="color:#11606a;margin:0 0 16px">Información Principal</h3>
            <dl style="margin:0;display:grid;gap:12px">
              <div>
                <dt style="color:#666;font-size:0.9em">ID del Reporte</dt>
                <dd style="margin:4px 0 0;font-weight:600">${reporte.id}</dd>
              </div>
              <div>
                <dt style="color:#666;font-size:0.9em">Remitente</dt>
                <dd style="margin:4px 0 0">${reporte.remitente || 'N/A'}</dd>
              </div>
              <div>
                <dt style="color:#666;font-size:0.9em">Clasificación</dt>
                <dd style="margin:4px 0 0">${reporte.clasificacion_name || 'N/A'}</dd>
              </div>
              <div>
                <dt style="color:#666;font-size:0.9em">Colonia</dt>
                <dd style="margin:4px 0 0">${reporte.colonia_name || 'N/A'}</dd>
              </div>
              <div>
                <dt style="color:#666;font-size:0.9em">Dirección</dt>
                <dd style="margin:4px 0 0">${reporte.calle || reporte.direccion || 'N/A'}</dd>
              </div>
            </dl>
          </div>
          
          <div>
            <h3 style="color:#11606a;margin:0 0 16px">Detalles y Estado</h3>
            <dl style="margin:0;display:grid;gap:12px">
              <div>
                <dt style="color:#666;font-size:0.9em">Descripción Detallada</dt>
                <dd style="margin:4px 0 0">${reporte.detalles || 'Sin detalles'}</dd>
              </div>
              <div>
                <dt style="color:#666;font-size:0.9em">Estado Actual</dt>
                <dd style="margin:4px 0 0">
                  <span class="status-badge ${reporte.estatus?.toLowerCase() === 'pendiente' ? 'status-pendiente' : 'status-completado'}">
                    ${reporte.estatus || 'Pendiente'}
                  </span>
                </dd>
              </div>
            </dl>
          </div>

          <div>
            <h3 style="color:#11606a;margin:0 0 16px">Información de Registro</h3>
            <dl style="margin:0;display:grid;gap:12px">
              <div>
                <dt style="color:#666;font-size:0.9em">Creado por</dt>
                <dd style="margin:4px 0 0">${reporte.creador_nombre || reporte.creado_por || 'N/A'}</dd>
              </div>
              <div>
                <dt style="color:#666;font-size:0.9em">Fecha de Creación</dt>
                <dd style="margin:4px 0 0">${fechaCreacion}</dd>
              </div>
              <div>
                <dt style="color:#666;font-size:0.9em">Última actualización</dt>
                <dd style="margin:4px 0 0">${reporte.fecha_actualizacion ? new Date(reporte.fecha_actualizacion).toLocaleDateString('es-MX', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                }) : 'N/A'}</dd>
              </div>
            </dl>
          </div>

          ${reporte.imagen_url || reporte.imagen ? `
            <div>
              <h3 style="color:#11606a;margin:0 0 16px">Imagen Adjunta</h3>
              <img src="${reporte.imagen_url || reporte.imagen}" 
                   alt="Imagen del reporte" 
                   style="width:100%;max-height:200px;object-fit:cover;border-radius:8px;cursor:pointer"
                   onclick="showImagePreview('${reporte.imagen_url || reporte.imagen}')">
            </div>
          ` : ''}
        </div>

        <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end">
          <a href="reportes_editar.html?id=${reporte.id}" 
             class="btn-primary" 
             style="text-decoration:none;padding:8px 16px;background:linear-gradient(180deg,#11606a,#0d4f56);color:white;border-radius:6px;font-weight:600">
            Editar Reporte
          </a>
          <button onclick="closeModal()" 
                  style="padding:8px 16px;border:1px solid #dce6ee;background:#fff;border-radius:6px;cursor:pointer">
            Cerrar
          </button>
        </div>
      `;
      
      modal.classList.add('show');
    }

    function closeModal() {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => modal.classList.remove('show'));
    }

    function showImagePreview(url) {
      const modal = document.getElementById('imageModal');
      const img = document.getElementById('modalImage');
      img.src = url;
      modal.classList.add('show');
    }

    // Cerrar modal con Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });
  </script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://ghywlqpirjqsmmlyomaw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoeXdscXBpcmpxc21tbHlvbWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTYwMTYsImV4cCI6MjA3NTM5MjAxNn0.v8fs-lpmWu7cmqM45wKvsFNaHJxcJro4dSxknDWgVGI';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    if (!sessionStorage.getItem('user')) window.location.href = 'login.html';

    const list = document.getElementById('list');
    const q = document.getElementById('q');
    const btn = document.getElementById('btnSearch');

    function showLoading(){
      const l = document.getElementById('loading');
      if (l){ l.style.display = 'flex'; l.setAttribute('aria-hidden','false'); }
    }
    function hideLoading(){
      const l = document.getElementById('loading');
      if (l){ l.style.display = 'none'; l.setAttribute('aria-hidden','true'); }
    }

    async function loadAll() {
      showLoading();
      try {
        const { data, error } = await supabase
          .from('reportes')
          .select('*')
          .order('id', {ascending:false});

        if (error) {
          console.error('Error de Supabase:', error);
          list.innerHTML = `<div style="color:crimson;padding:10px;background:#fee;border-radius:4px;">
            Error cargando datos: ${error.message || 'Error desconocido'}
          </div>`;
          return;
        }

        if (!data || data.length === 0) {
          list.innerHTML = '<div style="padding:10px;background:#f5f5f5;border-radius:4px;">No hay reportes disponibles</div>';
          return;
        }

        // Enriquecer con nombres de clasificación y colonia (si existen FK)
        const enriched = await enrichWithNames(data);
        renderTable(enriched);
      } catch (err) {
        console.error('Error general:', err);
        list.innerHTML = `<div style="color:crimson;padding:10px;background:#fee;border-radius:4px;">
          Error inesperado: ${err.message || 'Error desconocido'}
        </div>`;
      }
      finally{
        hideLoading();
      }
    }

    // Mapea FK a nombres consultando las tablas 'clasificaciones' y 'colonias' cuando sea necesario
    async function enrichWithNames(rows) {
      if (!rows || rows.length === 0) return rows;

      const first = rows[0];
      // posibles nombres de columna FK que podría tener tu tabla
      const possibleClasKeys = ['clasificacion_id', 'clasificacion', 'id_clasificacion'];
      const possibleColKeys = ['colonia_id', 'colonia', 'id_colonia'];

      const clasKey = possibleClasKeys.find(k => k in first);
      const colKey = possibleColKeys.find(k => k in first);

      const klasIds = clasKey ? [...new Set(rows.map(r => r[clasKey]).filter(Boolean))] : [];
      const colIds = colKey ? [...new Set(rows.map(r => r[colKey]).filter(Boolean))] : [];

  const klasMap = {};
  const colMap = {};
  const userMap = {};

      try {
        if (klasIds.length) {
          const { data: kdata, error: kerr } = await supabase
            .from('clasificaciones')
            .select('id, nombre')
            .in('id', klasIds);
          if (!kerr && kdata) kdata.forEach(x => klasMap[x.id] = x.nombre);
          else if (kerr) console.warn('No se pudo obtener clasificaciones:', kerr.message || kerr);
        }

        if (colIds.length) {
          const { data: cdata, error: cerr } = await supabase
            .from('colonias')
            .select('id, nombre_colonia')
            .in('id', colIds);
          if (!cerr && cdata) cdata.forEach(x => colMap[x.id] = x.nombre_colonia || x.nombre);
          else if (cerr) console.warn('No se pudo obtener colonias:', cerr.message || cerr);
        }
        // intentar resolver creado_por a nombre de usuario si existe la columna
        if ('creado_por' in first || 'creador_id' in first || 'creado_por_id' in first) {
          const userKey = 'creado_por' in first ? 'creado_por' : ('creador_id' in first ? 'creador_id' : 'creado_por_id');
          const userIds = [...new Set(rows.map(r => r[userKey]).filter(Boolean))];
          if (userIds.length) {
            // tablas comunes donde podría estar el usuario
            const possibleUserTables = ['backup_usuarios_20250820','usuarios','users'];
            for (const t of possibleUserTables) {
              try {
                const { data: udata, error: uerr } = await supabase
                  .from(t)
                  .select('id, usuario, nombre, nombre_completo, email')
                  .in('id', userIds);
                if (!uerr && udata && udata.length) {
                  udata.forEach(u => {
                    userMap[u.id] = u.nombre || u.nombre_completo || u.usuario || u.email || (`#${u.id}`);
                  });
                  break; // si encontramos en una tabla, salimos
                }
              } catch (ue){ console.warn('error buscando usuarios en', t, ue); }
            }
          }
        }
      } catch (err) {
        console.error('Error obteniendo tablas relacionadas:', err);
      }

      return rows.map(r => ({
        ...r,
        clasificacion_name: clasKey ? (typeof r[clasKey] === 'object' ? (r[clasKey].nombre || r[clasKey].nombre_clasificacion) : (klasMap[r[clasKey]] || null)) : null,
        colonia_name: colKey ? (typeof r[colKey] === 'object' ? (r[colKey].nombre_colonia || r[colKey].nombre) : (colMap[r[colKey]] || null)) : null,
        creador_nombre: ('creado_por' in r ? (userMap[r.creado_por] || null) : (('creador_id' in r ? (userMap[r.creador_id] || null) : (('creado_por_id' in r ? (userMap[r.creado_por_id] || null) : null)))))
      }));
    }

    function renderTable(rows) {
      if (!rows.length) { 
        list.innerHTML = '<div style="padding:20px;text-align:center;background:#f5f5f5;border-radius:8px;">No hay reportes disponibles</div>'; 
        return; 
      }
      
      const html = [`
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Remitente</th>
              <th>Clasificación</th>
              <th>Colonia</th>
              <th>Calle</th>
              <th>Fecha de Creación</th>
              <th>Creado por</th>
              <th>Estatus</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>`];
      
      rows.forEach(r => {
        const fechaCreacion = r.creado_en ? new Date(r.creado_en).toLocaleDateString('es-MX', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : 'N/A';
        
        const clas = r.clasificacion_name || 'N/A';
        const col = r.colonia_name || 'N/A';
        const calle = r.calle || r.direccion || 'N/A';
        const creadoPor = r.creador_nombre || r.creado_por || 'N/A';
        const imagen = r.imagen_url || r.imagen || null;
        
        html.push(`
          <tr data-id="${r.id}" onclick="showReporteDetails(${JSON.stringify(r).replace(/"/g, '&quot;')})">
            <td>${r.id || 'N/A'}</td>
            <td>${r.remitente || 'N/A'}</td>
            <td>${clas}</td>
            <td>${col}</td>
            <td>${calle}</td>
            <td>${fechaCreacion}</td>
            <td>${creadoPor}</td>
            <td>
              <span class="status-badge ${r.estatus?.toLowerCase() === 'pendiente' ? 'status-pendiente' : 'status-completado'}">
                ${r.estatus || 'Pendiente'}
              </span>
            </td>
            <td style="display:flex;gap:8px;align-items:center">
              <button onclick="event.stopPropagation(); showReporteDetails(${JSON.stringify(r).replace(/"/g, '&quot;')})" 
                      style="background:none;border:none;cursor:pointer;color:#11606a;padding:6px;border-radius:4px;display:flex;align-items:center;gap:4px">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                Ver
              </button>
              <button onclick="event.stopPropagation(); window.location.href='reportes_editar.html?id=${r.id}'" 
                      style="background:none;border:none;cursor:pointer;color:#2E86DE;padding:6px;border-radius:4px;display:flex;align-items:center;gap:4px">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Editar
              </button>
              ${imagen ? 
                `<button onclick="event.stopPropagation(); showImagePreview('${imagen}')" 
                         style="background:none;border:none;cursor:pointer;color:#6c2ea9;padding:6px;border-radius:4px;display:flex;align-items:center;gap:4px">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                  Imagen
                </button>` 
                : ''}
            </td>
          </tr>`)
      })
  html.push('</tbody></table>');
      list.innerHTML = html.join('');

      // attach double click
      document.querySelectorAll('#list tbody tr').forEach(tr=>{
        tr.addEventListener('dblclick', ()=>{
          const id = tr.getAttribute('data-id');
          window.location.href = `reportes_editar.html?id=${id}`;
        });
      });
    }

    btn.addEventListener('click', async ()=>{
      try {
        const v = q.value.trim();
        if (!v) { 
          loadAll(); 
          return; 
        }
        showLoading();

        // Consulta simple que incluye FKs (si existen). Luego enriquecemos los resultados.
        let query = supabase
          .from('reportes')
          .select('*');

        if (/^\d+$/.test(v)) {
          query = query.eq('id', parseInt(v)).limit(1);
        } else {
          query = query.ilike('remitente', `%${v}%`).order('id', {ascending:false});
        }

        const { data, error } = await query;

        if (error) {
          console.error('Error de búsqueda:', error);
          list.innerHTML = `<div style="color:crimson;padding:10px;background:#fee;border-radius:4px;">
            Error en la búsqueda: ${error.message || 'Error desconocido'}
          </div>`;
          return;
        }

        if (!data || data.length === 0) {
          list.innerHTML = '<div style="padding:10px;background:#f5f5f5;border-radius:4px;">No se encontraron reportes</div>';
          return;
        }

        const enriched = await enrichWithNames(data);
        renderTable(enriched);
      } catch (err) {
        console.error('Error general:', err);
        list.innerHTML = `<div style="color:crimson;padding:10px;background:#fee;border-radius:4px;">
          Error inesperado: ${err.message || 'Error desconocido'}
        </div>`;
      }
      finally{
        hideLoading();
      }
    });

    loadAll();
  </script>
  <script>
    // attach logout link
    const logoutLink = document.getElementById('logout-link');
    if (logoutLink) logoutLink.addEventListener('click', (e)=>{ e.preventDefault(); sessionStorage.removeItem('user'); window.location.href='login.html'; });
  </script>
</body>
</html>