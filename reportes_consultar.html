<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Consultar Reportes - CityReport</title>
  <link rel="stylesheet" href="css/loader.css">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="css/cityreport-theme.css">
  <style>
    /* Panel y contenedor */
    .panel{
      max-width:1100px;
      margin:28px auto;
      background:#ffffff;
      padding:18px 20px;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(21,40,60,0.08);
      border: 1px solid rgba(18,52,84,0.04);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .panel:hover{ transform: translateY(-4px); box-shadow:0 18px 40px rgba(21,40,60,0.10); }

    /* Barra de búsqueda */
    .searchRow{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:18px;
    }
    .searchRow input{
      flex:1;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #dce6ee;
      background:#fbfdff;
      font-size:14px;
      color:#1f2d3d;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }
    .searchRow button{
      padding:10px 14px;
      border-radius:8px;
      border:none;
      background:var(--brand-ink);
      color:white;font-weight:600;cursor:pointer;
      box-shadow:0 6px 18px rgba(16,81,88,0.08);
    }
    .searchRow a{
      color:#6c2ea9;text-decoration:underline;font-weight:600;padding-left:6px
    }

    /* Tabla */
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
    thead th{
      background:#f8fafd;
      color:#213041;
      padding:14px 12px;
      text-align:left;
      font-weight:600;
      border-bottom:2px solid #eef6fb;
      position:sticky;
      top:0;
      z-index:10;
    }
    tbody td{
      padding:14px 12px;
      border-bottom:1px solid #f1f6f9;
      color:#233040;
      vertical-align:middle;
    }
    tbody tr{
      cursor:pointer;
      transition:all 0.2s ease;
    }
    tbody tr:hover{
      background:linear-gradient(90deg,#f8fafd,#f3f8fc);
      transform:translateY(-1px);
      box-shadow:0 2px 8px rgba(21,40,60,0.04);
    }
    td:first-child{
      width:80px;
      color:#0f2b3b;
      font-family:monospace;
      font-weight:600;
    }

    /* Modal */
    .modal { display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.5); z-index:1000; padding:20px; overflow-y:auto; }
    .modal-content { background:#fff; max-width:800px; margin:40px auto; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,0.2); padding:24px; }
    .modal.show { display:block; }

    /* Badge estatus */
    .status-badge{display:inline-block;padding:6px 10px;border-radius:8px;font-weight:600;font-size:0.9em}
    .status-pendiente{background:#fff3cd;color:#856404}
    .status-completado{background:#d1e7dd;color:#155724}

    /* Loading overlay (estructura básica, sin spinner interno) */
    .loading-overlay{position:relative}
    #list-container{min-height:140px;position:relative}

    /* Botones */
    .btn-action {
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.75rem 1.25rem; text-decoration:none;
      background:var(--brand-ink);
      color:#fff; font-weight:500; border-radius:8px;
      transition:.2s ease; box-shadow:0 4px 6px -1px rgba(13,79,86,.1);
      border:none; cursor:pointer;
    }
    .btn-action:hover { transform:translateY(-1px); box-shadow:0 6px 8px -1px rgba(13,79,86,.15); }

    /* Responsivo */
    @media (max-width:720px){
      .panel{ padding:10px; margin:10px; }
      header > div { flex-direction:column; padding:10px !important; }
      header nav { flex-wrap:wrap; justify-content:center; gap:8px !important; }
      div[style*="display:flex;align-items:center;gap:12px"] { padding:10px !important; }
      div[style*="display:flex;align-items:center;gap:12px"] img { height:100px !important; }

      .searchRow { flex-direction:column; gap:8px; }
      #list-container { overflow-x:auto; -webkit-overflow-scrolling:touch; }
      table { min-width:800px; }
      thead th, tbody td { padding:8px; font-size:.9em; }
      .btn-action{ width:100%; justify-content:center; }
      .modal-content { margin:10px; padding:15px; }
      .status-badge { padding:4px 8px; font-size:.8em; }
      td[style*="display:flex"] { flex-direction:column; gap:4px; }
    }
  </style>
</head>
<body>
  <!-- Loader global -->
  <div id="loader" class="loader-wrapper">
    <div class="container">
      <div class="dot"></div>
      <div class="traveler"></div>
    </div>

    <svg width="0" height="0" class="svg">
      <defs>
        <filter id="uib-jelly-triangle-ooze">
          <feGaussianBlur in="SourceGraphic" stdDeviation="3.333" result="blur" />
          <feColorMatrix
            in="blur"
            mode="matrix"
            values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7"
            result="ooze"
          />
          <feBlend in="SourceGraphic" in2="ooze" />
        </filter>
      </defs>
    </svg>
  </div>

  <header style="background:linear-gradient(180deg,#154965,#154965);color:#fff;padding:18px 0;">
    <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:0 18px;">
      <div style="display:flex;align-items:center;gap:12px;padding:16px">
        <a href="index.html" style="display:flex;align-items:center;gap:16px;">
          <img src="img/urbano.png" alt="Urbano" style="height:140px;background:white;padding:10px;border-radius:10px;box-shadow:0 3px 6px rgba(0,0,0,0.15)">
          <img src="img/logo_city.png" alt="CityReport" style="height:138px;background:white;padding:10px;border-radius:10px;box-shadow:0 3px 6px rgba(0,0,0,0.15)">
        </a>
      </div>
      <div style="flex:1;text-align:center">
        <h1 style="margin:0;font-size:26px;">Consultar Reportes</h1>
      </div>

      <!-- NAV -->
      <nav style="display:flex;gap:12px;align-items:center">
        <a href="index.html" style="color:#dff3ff;text-decoration:none;display:flex;align-items:center;gap:4px">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
          </svg>
          Inicio
        </a>

        <a href="reportes_consultar.html" aria-current="page"
           style="color:#fff;text-decoration:none;display:flex;align-items:center;gap:4px;font-weight:700">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
          </svg>
          Reportes
        </a>

        <a href="estadisticas.html" style="color:#dff3ff;text-decoration:none;display:flex;align-items:center;gap:4px">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          Estadísticas
        </a>

        <!-- Solo admins -->
        <a href="usuarios.html" class="admin-only"
           style="display:none;color:#dff3ff;text-decoration:none;align-items:center;gap:4px">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M17 20h5v-2a4 4 0 00-5-3.87M9 20H4v-2a4 4 0 0 1 5-3.87M12 12a4 4 0 100-8 4 4 0 000 8z"/>
          </svg>
          Usuarios
        </a>

        <a href="#" id="logout-link" style="color:#ffd;text-decoration:none;display:flex;align-items:center;gap:4px">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          Cerrar sesión
        </a>
      </nav>
    </div>
  </header>

  <!-- Control de rol -->
  <script>
    (function setupRole(){
      const raw = sessionStorage.getItem('user');
      if (!raw) { window.location.href = 'login.html'; return; }
      let u = null; try { u = JSON.parse(raw); } catch {}
      if (!u || typeof u.id_rol === 'undefined') { window.location.href = 'login.html'; return; }

      const role = Number(u.id_rol);
      const isAdmin   = role === 1;
      const canCreate = role === 1 || role === 2; // Admin + Coordinador

      document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = isAdmin ? 'flex' : 'none';
      });

      window.addEventListener('DOMContentLoaded', () => {
        const btnNuevo = document.getElementById('btnNuevoReporte');
        if (btnNuevo && !canCreate) btnNuevo.style.display = 'none';
      });

      document.getElementById('logout-link')?.addEventListener('click', (e)=>{
        e.preventDefault();
        sessionStorage.removeItem('user');
        window.location.href='login.html';
      });
    })();
  </script>

  <main>
    <div class="panel">
      <div style="margin-bottom:1rem">
        <a href="index.html" class="btn btn-secondary btn-action">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Volver
        </a>
      </div>

      <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1.5rem">
        <div style="display:flex;gap:0.75rem;flex:1">
          <input type="text" id="q" 
                placeholder="Buscar por ID o remitente..." 
                aria-label="Buscar reportes"
                class="form-control"
                style="flex:1;padding:0.75rem 1rem;border-radius:8px;border:1px solid var(--gray-200);background:white;font-size:0.875rem;color:var(--gray-900)">
          <button id="btnSearch" class="btn-action">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            Buscar
          </button>
        </div>
        <a id="btnNuevoReporte" href="reportes_agregar.html" class="btn btn-primary btn-action">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 4v16m8-8H4"/>
          </svg>
          Nuevo Reporte
        </a>
      </div>

      <div id="list-container" class="loading-overlay">
        <div id="list"></div>
      </div>
    </div>
  </main>

  <!-- Modal detalles -->
  <div id="reporteModal" class="modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2 style="margin:0">Detalles del Reporte</h2>
        <button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer;padding:4px 8px">&times;</button>
      </div>
      <div id="reporteDetails"></div>
    </div>
  </div>

  <!-- Modal imagen -->
  <div id="imageModal" class="modal" onclick="this.classList.remove('show')" style="background:rgba(0,0,0,0.9)">
    <div style="height:100%;display:flex;align-items:center;justify-content:center">
      <img id="modalImage" style="max-width:90%;max-height:90%;object-fit:contain;border-radius:8px" src="" alt="Previsualización">
    </div>
  </div>

  <!-- Funciones de detalle / modal -->
  <script>
    function showReporteDetails(reporte) {
      const modal = document.getElementById('reporteModal');
      const details = document.getElementById('reporteDetails');

      const fechaCreacion = reporte.creado_en
        ? new Date(reporte.creado_en).toLocaleDateString('es-MX',{
            year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'
          })
        : 'N/A';

      details.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px">
          <div>
            <h3 style="color:#11606a;margin:0 0 16px">Información Principal</h3>
            <dl style="margin:0;display:grid;gap:12px">
              <div><dt style="color:#666;font-size:.9em">ID del Reporte</dt><dd style="margin:4px 0 0;font-weight:600">${reporte.id}</dd></div>
              <div><dt style="color:#666;font-size:.9em">Remitente</dt><dd style="margin:4px 0 0">${reporte.remitente || 'N/A'}</dd></div>
              <div><dt style="color:#666;font-size:.9em">Clasificación</dt><dd style="margin:4px 0 0">${reporte.clasificacion_name || 'N/A'}</dd></div>
              <div><dt style="color:#666;font-size:.9em">Colonia</dt><dd style="margin:4px 0 0">${reporte.colonia_name || 'N/A'}</dd></div>
              <div><dt style="color:#666;font-size:.9em">Dirección</dt><dd style="margin:4px 0 0">${reporte.calle || reporte.direccion || 'N/A'}</dd></div>
            </dl>
          </div>
          <div>
            <h3 style="color:#11606a;margin:0 0 16px">Detalles y Estado</h3>
            <dl style="margin:0;display:grid;gap:12px">
              <div><dt style="color:#666;font-size:.9em">Descripción Detallada</dt><dd style="margin:4px 0 0">${reporte.detalles || 'Sin detalles'}</dd></div>
              <div><dt style="color:#666;font-size:.9em">Estado Actual</dt><dd style="margin:4px 0 0">
                <span class="status-badge ${reporte.estatus?.toLowerCase()==='pendiente'?'status-pendiente':'status-completado'}">${reporte.estatus || 'Pendiente'}</span>
              </dd></div>
            </dl>
          </div>
          <div>
            <h3 style="color:#11606a;margin:0 0 16px">Información de Registro</h3>
            <dl style="margin:0;display:grid;gap:12px">
              <div><dt style="color:#666;font-size:.9em">Creado por</dt><dd style="margin:4px 0 0">${reporte.creador_nombre || reporte.creado_por || 'N/A'}</dd></div>
              <div><dt style="color:#666;font-size:.9em">Fecha de Creación</dt><dd style="margin:4px 0 0">${fechaCreacion}</dd></div>
              <div><dt style="color:#666;font-size:.9em">Última actualización</dt><dd style="margin:4px 0 0">${reporte.fecha_actualizacion ? new Date(reporte.fecha_actualizacion).toLocaleDateString('es-MX',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'}) : 'N/A'}</dd></div>
            </dl>
          </div>
          ${reporte.imagen_url || reporte.imagen ? `
            <div>
              <h3 style="color:#11606a;margin:0 0 16px">Imagen Adjunta</h3>
              <img src="${reporte.imagen_url || reporte.imagen}" alt="Imagen del reporte"
                   style="width:100%;max-height:200px;object-fit:cover;border-radius:8px;cursor:pointer"
                   onclick="showImagePreview('${reporte.imagen_url || reporte.imagen}')">
            </div>` : ``}
        </div>
        <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end">
          <a href="reportes_editar.html?id=${reporte.id}" class="btn btn-primary"
             style="text-decoration:none;padding:8px 16px;border-radius:6px;font-weight:600">
            Editar Reporte
          </a>
          <button onclick="closeModal()" style="padding:8px 16px;border:1px solid #dce6ee;background:#fff;border-radius:6px;cursor:pointer">
            Cerrar
          </button>
        </div>`;
      modal.classList.add('show');
    }
    function closeModal(){ document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show')); }
    function showImagePreview(url){ const m=document.getElementById('imageModal'); const img=document.getElementById('modalImage'); img.src=url; m.classList.add('show'); }
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeModal(); });
  </script>

  <!-- Script principal: REST Supabase (sin supabase-js) -->
  <script>
    // Bloqueo por sesión
    if (!sessionStorage.getItem('user')) {
      window.location.href = 'login.html';
    }

    const SUPABASE_URL = 'https://ghywlqpirjqsmmlyomaw.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoeXdscXBpcmpxc21tbHlvbWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTYwMTYsImV4cCI6MjA3NTM5MjAxNn0.v8fs-lpmWu7cmqM45wKvsFNaHJxcJro4dSxknDWgVGI';

    const list = document.getElementById('list');
    const q    = document.getElementById('q');

    function showLoading(){
      const l = document.getElementById('loader');
      if (l) l.style.display = 'flex';
    }
    function hideLoading(){
      const l = document.getElementById('loader');
      if (l) l.style.display = 'none';
    }

    // Helper genérico para llamadas REST
    async function restSelect(table, options = {}) {
      const { select = '*', ...filters } = options;
      const url = new URL(SUPABASE_URL + '/rest/v1/' + table);
      url.searchParams.set('select', select);
      Object.entries(filters).forEach(([k,v]) => url.searchParams.append(k, v));

      const resp = await fetch(url.toString(), {
        method: 'GET',
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: 'Bearer ' + SUPABASE_ANON_KEY,
          'Content-Type': 'application/json',
        },
      });

      if (!resp.ok) {
        const txt = await resp.text();
        throw new Error(txt || ('Error HTTP ' + resp.status));
      }
      return await resp.json();
    }

    async function enrichWithNames(rows){
      if(!rows || !rows.length) return rows;
      const first = rows[0];

      const possibleClasKeys = ['clasificacion_id','clasificacion','id_clasificacion'];
      const possibleColKeys  = ['colonia_id','colonia','id_colonia'];
      const clasKey = possibleClasKeys.find(k=>k in first);
      const colKey  = possibleColKeys.find(k=>k in first);

      const klasIds = clasKey ? [...new Set(rows.map(r=>r[clasKey]).filter(Boolean))] : [];
      const colIds  = colKey  ? [...new Set(rows.map(r=>r[colKey]).filter(Boolean))]  : [];
      const klasMap={}, colMap={}, userMap={};

      try{
        if(klasIds.length){
          const inList = '(' + klasIds.join(',') + ')';
          const kdata = await restSelect('clasificaciones', {
            select: 'id,nombre',
            id: 'in.' + inList
          });
          (kdata||[]).forEach(x=>klasMap[x.id]=x.nombre);
        }
        if(colIds.length){
          const inList = '(' + colIds.join(',') + ')';
          const cdata = await restSelect('colonias', {
            select: 'id,nombre_colonia',
            id: 'in.' + inList
          });
          (cdata||[]).forEach(x=>colMap[x.id]=x.nombre_colonia || x.nombre);
        }

        const userKey = ('creado_por' in first)
          ? 'creado_por'
          : (('creador_id' in first)
              ? 'creador_id'
              : (('creado_por_id' in first) ? 'creado_por_id' : null));

        if(userKey){
          const userIds=[...new Set(rows.map(r=>r[userKey]).filter(Boolean))];
          const inList = '(' + userIds.join(',') + ')';
          const tables=['backup_usuarios_20250820','usuarios','users'];

          for(const t of tables){
            try{
              const udata = await restSelect(t,{
                select:'id,usuario,nombre,nombre_completo,email',
                id:'in.'+inList
              });
              if(udata && udata.length){
                udata.forEach(u=>{
                  userMap[u.id]=u.nombre||u.nombre_completo||u.usuario||u.email||(`#${u.id}`);
                });
                break;
              }
            }catch(e){
              console.warn('Error leyendo tabla usuarios auxiliar', t, e.message);
            }
          }
        }
      }catch(e){
        console.warn('Error enriquecer nombres:', e);
      }

      return rows.map(r=>({
        ...r,
        clasificacion_name: clasKey
          ? (typeof r[clasKey]==='object'
             ? (r[clasKey].nombre||r[clasKey].nombre_clasificacion)
             : (klasMap[r[clasKey]]||null))
          : null,
        colonia_name: colKey
          ? (typeof r[colKey]==='object'
             ? (r[colKey].nombre_colonia||r[colKey].nombre)
             : (colMap[r[colKey]]||null))
          : null,
        creador_nombre: ('creado_por' in r
          ? userMap[r.creado_por]
          : ('creador_id' in r
              ? userMap[r.creador_id]
              : ('creado_por_id' in r
                  ? userMap[r.creado_por_id]
                  : null)))
      }));
    }

    function renderTable(rows){
      if(!rows.length){
        list.innerHTML='<div style="padding:20px;text-align:center;background:#f5f5f5;border-radius:8px;">No hay reportes disponibles</div>';
        return;
      }
      const html=[`
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Remitente</th><th>Clasificación</th><th>Colonia</th>
              <th>Calle</th><th>Fecha de Creación</th><th>Creado por</th><th>Estatus</th><th>Acciones</th>
            </tr>
          </thead><tbody>`];

      rows.forEach(r=>{
        const fechaCreacion = r.creado_en
          ? new Date(r.creado_en).toLocaleDateString('es-MX',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'})
          : 'N/A';
        const clas  = r.clasificacion_name || 'N/A';
        const col   = r.colonia_name || 'N/A';
        const calle = r.calle || r.direccion || 'N/A';
        const creadoPor = r.creador_nombre || r.creado_por || 'N/A';
        const imagen = r.imagen_url || r.imagen || null;

        const jsonRow = JSON.stringify(r).replace(/"/g,'&quot;');

        html.push(`
          <tr data-id="${r.id}" onclick="showReporteDetails(${jsonRow})">
            <td>${r.id || 'N/A'}</td>
            <td>${r.remitente || 'N/A'}</td>
            <td>${clas}</td>
            <td>${col}</td>
            <td>${calle}</td>
            <td>${fechaCreacion}</td>
            <td>${creadoPor}</td>
            <td><span class="status-badge ${r.estatus?.toLowerCase()==='pendiente'?'status-pendiente':'status-completado'}">${r.estatus || 'Pendiente'}</span></td>
            <td style="display:flex;gap:8px;align-items:center">
              <button onclick="event.stopPropagation(); showReporteDetails(${jsonRow})" class="btn-action">Ver</button>
              <button onclick="event.stopPropagation(); window.location.href='reportes_editar.html?id=${r.id}'" class="btn-action">Editar</button>
              ${imagen ? `<button onclick="event.stopPropagation(); showImagePreview('${imagen}')" class="btn btn-primary btn-action">Imagen</button>` : ``}
            </td>
          </tr>`);
      });
      html.push('</tbody></table>');
      list.innerHTML = html.join('');

      document.querySelectorAll('#list tbody tr').forEach(tr=>{
        tr.addEventListener('dblclick', ()=>{
          const id = tr.getAttribute('data-id');
          window.location.href = `reportes_editar.html?id=${id}`;
        });
      });
    }

    async function loadAll(){
      showLoading();
      try{
        const data = await restSelect('reportes', {
          select:'*',
          order:'id.desc'
        });
        if(!data || !data.length){
          list.innerHTML='<div style="padding:10px;background:#f5f5f5;border-radius:4px;">No hay reportes disponibles</div>';
          return;
        }
        const enriched = await enrichWithNames(data);
        renderTable(enriched);
      }catch(err){
        console.error(err);
        list.innerHTML = `<div style="color:crimson;padding:10px;background:#fee;border-radius:4px;">Error: ${err.message||'desconocido'}</div>`;
      }finally{ hideLoading(); }
    }

    document.getElementById('btnSearch').addEventListener('click', async ()=>{
      const v = q.value.trim();
      if(!v){ loadAll(); return; }
      showLoading();
      try{
        let params = { select:'*' };

        if(/^\d+$/.test(v)){         // buscar por ID
          params.id = 'eq.' + parseInt(v);
        } else {                     // buscar por remitente (ilike)
          params.remitente = 'ilike.*' + v + '*';
          params.order = 'id.desc';
        }

        const data = await restSelect('reportes', params);
        if(!data || !data.length){
          list.innerHTML='<div style="padding:10px;background:#f5f5f5;border-radius:4px;">No se encontraron reportes</div>';
          return;
        }
        const enriched = await enrichWithNames(data);
        renderTable(enriched);
      }catch(err){
        console.error(err);
        list.innerHTML = `<div style="color:crimson;padding:10px;background:#fee;border-radius:4px;">Error búsqueda: ${err.message||'desconocido'}</div>`;
      }finally{ hideLoading(); }
    });

    // Carga inicial
    loadAll();
  </script>
</body>
</html>
