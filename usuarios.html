<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gestión de Usuarios - CityReport</title>
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="css/loader.css">
  <link rel="stylesheet" href="css/cityreport-theme.css">
  <link rel="stylesheet" href="css/tables.css">
  <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
  <style>
    .page-wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    .title { text-align:center; margin: 8px 0 18px; color:var(--brand-ink); font-size: 28px; font-weight: 700; }

    .btn-bar {
      display:flex; gap:.75rem; justify-content:center; margin: 0 0 1rem;
    }

    .btn {
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.6rem 1rem; border:none;
      border-radius: var(--radius, 10px);
      cursor:pointer; color:#fff;
      background:var(--brand-ink);
      box-shadow:0 4px 10px rgba(21,73,101,.12);
      transition:.2s;
    }
    .btn:hover { transform: translateY(-1px); box-shadow:0 6px 14px rgba(21,73,101,.16); }
    .btn-green  { background:var(--brand-ink); }
    .btn-blue   { background:var(--brand-ink); }
    .btn-red    { background:#c0392b; }
    .btn-secondary { background:#6b7280; }

    .form-grid{
      display:grid;
      grid-template-columns: 120px 1fr 180px 150px 260px;
      gap:12px 18px;
      align-items:flex-start;
    }
    .form-grid label { display:block; font-weight:600; margin-bottom:6px; color:#374151; }
    .form-grid input, .form-grid select {
      width:100%; padding:10px;
      border:1px solid #e5e7eb; border-radius:8px; background:#fff;
    }
    .form-actions { display:flex; gap:.6rem; justify-content:flex-end; margin-top:.75rem; }
    .hint { color:#6b7280; font-size:.85rem; margin-top:4px; }

    .table thead th { background:var(--brand-ink); color:#fff; border-bottom:0; }
    .table tbody tr:hover { background:#f4f8fa; transform:none; }

    .badge-estado{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:0.78rem;
      font-weight:600;
    }
    .estado-activo{
      background:#d1e7dd;
      color:#0f5132;
    }
    .estado-inactivo{
      background:#f8d7da;
      color:#842029;
    }

    tbody tr.selected {
      background:#e0f2fe;
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader-wrapper">
    <div class="container">
      <div class="dot"></div>
      <div class="traveler"></div>
    </div>

    <svg width="0" height="0" class="svg">
      <defs>
        <filter id="uib-jelly-triangle-ooze">
          <feGaussianBlur in="SourceGraphic" stdDeviation="3.333" result="blur" />
          <feColorMatrix
            in="blur"
            mode="matrix"
            values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7"
            result="ooze"
          />
          <feBlend in="SourceGraphic" in2="ooze" />
        </filter>
      </defs>
    </svg>
  </div>

  <!-- Header -->
  <header class="main-header">
    <div class="header-container">
      <div class="logo-container">
        <a href="index.html" class="logo-link header-logos">
          <img src="img/urbano.png" alt="Urbano" class="logo-img logo-urbano">
          <img src="img/logo_city.png" alt="CityReport" class="logo-img logo-city">
        </a>
      </div>
      <div class="header-title">
        <h1>CityReport</h1>
        <div class="header-subtitle">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
          </svg>
          Gestión de usuarios
        </div>
      </div>
      <nav class="main-nav">
        <a href="index.html" class="nav-link"
           style="color:#dff3ff;text-decoration:none;display:flex;align-items:center;gap:4px">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
          </svg>
          Inicio
        </a>

        <a href="reportes_consultar.html" class="nav-link"
           style="color:#dff3ff;text-decoration:none;display:flex;align-items:center;gap:4px">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
          </svg>
          Reportes
        </a>

        <a href="estadisticas.html" class="nav-link"
           style="color:#dff3ff;text-decoration:none;display:flex;align-items:center;gap:4px">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          Estadísticas
        </a>

        <a href="usuarios.html" class="nav-link active" aria-current="page"
           style="color:#fff;text-decoration:none;display:flex;align-items:center;gap:4px;font-weight:700">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M17 20h5v-2a4 4 0 00-5-3.87M9 20H4v-2a4 4 0 0 1 5-3.87M12 12a4 4 0 100-8 4 4 0 000 8z"/>
          </svg>
          Usuarios
        </a>

        <a href="#" id="logout-link"
           style="color:#ffd;text-decoration:none;display:flex;align-items:center;gap:4px">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          Cerrar sesión
        </a>
      </nav>
    </div>
  </header>

  <!-- Contenido principal -->
  <main class="page-wrap">
    <div class="panel">
      <div class="title">Gestión de Usuarios</div>

      <div class="btn-bar">
        <button id="btnAdd" class="btn btn-green">Agregar Usuario</button>
        <button id="btnEdit" class="btn btn-blue">Editar Usuario</button>
        <button id="btnDelete" class="btn btn-red">Eliminar Usuario</button>
      </div>

      <div class="table-responsive">
        <table class="table" id="usersTable">
          <thead>
            <tr>
              <th style="width:90px">ID</th>
              <th>Usuario</th>
              <th style="width:180px">Rol</th>
              <th style="width:120px">Estado</th>
            </tr>
          </thead>
          <tbody id="usersBody"></tbody>
        </table>
      </div>

      <div class="panel" style="margin-top:1rem; padding:1.25rem">
        <form id="userForm">
          <div class="form-grid">
            <div>
              <label for="fid">ID</label>
              <input id="fid" type="text" placeholder="(auto)" readonly>
            </div>

            <div>
              <label for="fusuario">Usuario</label>
              <input id="fusuario" type="text" placeholder="usuario_sistema" required>
            </div>

            <div>
              <label for="frol">Rol</label>
              <select id="frol">
                <option value="1">admin_sys</option>
                <option value="2">coordinador</option>
                <option value="3">supervisor</option>
              </select>
            </div>

            <div>
              <label for="festado">Estado</label>
              <select id="festado">
                <option value="true">Activo</option>
                <option value="false">Inactivo</option>
              </select>
            </div>

            <div>
              <label for="fpass">Contraseña</label>
              <input id="fpass" type="password" placeholder="Dejar vacío para no cambiar">
              <div class="hint">Para crear usuario es obligatorio.</div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-green" id="btnSave">Guardar</button>
            <button type="button" class="btn btn-secondary" id="btnCancel">Cancelar</button>
          </div>
          <div id="msg" class="hint" style="margin-top:.5rem"></div>
        </form>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="pie">
    <div class="contenedor">&copy; <span id="year"></span> CityReport — Todos los derechos reservados</div>
  </footer>

  <!-- Lógica de negocio -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.48.0';

    const SUPABASE_URL = 'https://ghywlqpirjqsmmlyomaw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoeXdscXBpcmpxc21tbHlvbWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTYwMTYsImV4cCI6MjA3NTM5MjAxNn0.v8fs-lpmWu7cmqM45wKvsFNaHJxcJro4dSxknDWgVGI';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabase = supabase; // solo para pruebas

    const bcrypt = window.dcodeIO?.bcrypt;

    const raw = sessionStorage.getItem('user');
    if (!raw) location.href = 'login.html';
    const currentUser = JSON.parse(raw);

    const roleName = (id) => id == 1 ? 'admin_sys' : id == 2 ? 'coordinador' : 'supervisor';

    if (Number(currentUser.id_rol) !== 1) {
      alert('Solo administradores pueden gestionar usuarios.');
      location.href = 'index.html';
    }
    document.body.setAttribute('data-role', 'admin_sys');

    const tbody     = document.getElementById('usersBody');
    const fId       = document.getElementById('fid');
    const fUser     = document.getElementById('fusuario');
    const fRol      = document.getElementById('frol');
    const fEstado   = document.getElementById('festado');
    const fPass     = document.getElementById('fpass');
    const form      = document.getElementById('userForm');
    const msg       = document.getElementById('msg');
    const btnAdd    = document.getElementById('btnAdd');
    const btnEdit   = document.getElementById('btnEdit');
    const btnDel    = document.getElementById('btnDelete');
    const btnCancel = document.getElementById('btnCancel');

    document.getElementById('year').textContent = new Date().getFullYear();

    document.getElementById('logout-link').addEventListener('click', (e) => {
      e.preventDefault();
      sessionStorage.removeItem('user');
      location.href = 'login.html';
    });

    let selected = null;

    function setMessage(text, ok = false) {
      msg.textContent = text || '';
      msg.style.color = ok ? 'green' : '#6b7280';
    }

    function clearForm() {
      fId.value = '';
      fUser.value = '';
      fRol.value = '2';
      fEstado.value = 'true';
      fPass.value = '';
      setMessage('');
    }

    function selectRow(u, tr) {
      Array.from(tbody.querySelectorAll('tr')).forEach(r => r.classList.remove('selected'));
      tr.classList.add('selected');
      selected = u;

      fId.value     = u.id;
      fUser.value   = u.usuario || '';
      fRol.value    = u.id_rol || 2;
      fEstado.value = u.estado ? 'true' : 'false';
      fPass.value   = '';
      setMessage(`Editando: ${u.usuario}`);
    }

    async function loadUsers() {
      selected = null;
      tbody.innerHTML = '';

      const { data, error } = await supabase
        .from('usuarios')
        .select('id, usuario, id_rol, estado')
        .order('id', { ascending: true });

      if (error) {
        console.error('Error SELECT usuarios:', error);
        setMessage(`Error al cargar usuarios: ${error.message || ''}`);
        return;
      }

      if (!data || data.length === 0) {
        setMessage('No hay usuarios visibles. Revisa RLS o que existan datos en la tabla.');
        return;
      }

      for (const u of data) {
        const tr = document.createElement('tr');
        const activo = u.estado === null ? true : !!u.estado;
        tr.innerHTML = `
          <td>${u.id}</td>
          <td>${u.usuario}</td>
          <td>${roleName(u.id_rol)}</td>
          <td>
            <span class="badge-estado ${activo ? 'estado-activo' : 'estado-inactivo'}">
              ${activo ? 'Activo' : 'Inactivo'}
            </span>
          </td>
        `;
        tr.addEventListener('click', () => selectRow({ ...u, estado: activo }, tr));
        tbody.appendChild(tr);
      }
    }

    btnAdd.addEventListener('click', () => {
      clearForm();
      fUser.focus();
      setMessage('Creación de usuario nuevo');
    });

    btnEdit.addEventListener('click', () => {
      if (!selected) return setMessage('Selecciona un usuario de la tabla.');
      fId.value     = selected.id;
      fUser.value   = selected.usuario || '';
      fRol.value    = selected.id_rol || 2;
      fEstado.value = selected.estado ? 'true' : 'false';
      fPass.value   = '';
      setMessage(`Editando: ${selected.usuario}`);
    });

    btnDel.addEventListener('click', async () => {
      if (!selected) return setMessage('Selecciona un usuario de la tabla.');
      if (!confirm(`¿Eliminar al usuario "${selected.usuario}"?`)) return;

      const { error } = await supabase.from('usuarios').delete().eq('id', selected.id);
      if (error) {
        console.error('Error DELETE usuario:', error);
        return setMessage('Error al eliminar usuario.');
      }
      setMessage('Usuario eliminado', true);
      clearForm();
      await loadUsers();
    });

    btnCancel.addEventListener('click', () => {
      clearForm();
      Array.from(tbody.querySelectorAll('tr')).forEach(r => r.classList.remove('selected'));
      selected = null;
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setMessage('');

      const id     = fId.value.trim();
      const user   = fUser.value.trim();
      const idRol  = Number(fRol.value || 2);
      const pass   = fPass.value;
      const estado = fEstado.value === 'true';

      if (!user) return setMessage('El usuario no puede ir vacío.');

      const payload = {
        usuario: user,
        id_rol: idRol,
        estado: estado
      };

      if (pass) {
        if (!bcrypt) return setMessage('Error con verificador de contraseñas.');
        const salt = bcrypt.genSaltSync(10);
        payload.contrasena = bcrypt.hashSync(pass, salt);
      } else if (!id) {
        return setMessage('Para crear un usuario debes indicar una contraseña.');
      }

      try {
        if (id) {
          const { error } = await supabase.from('usuarios').update(payload).eq('id', id);
          if (error) throw error;
          setMessage('Usuario actualizado', true);
        } else {
          const { error } = await supabase.from('usuarios').insert(payload);
          if (error) throw error;
          setMessage('Usuario creado', true);
        }
        clearForm();
        await loadUsers();
      } catch (err) {
        console.error('Error al guardar usuario:', err);
        setMessage('Error al guardar usuario.');
      }
    });

    await loadUsers();
  </script>

  <!-- Ocultar loader -->
  <script>
    window.addEventListener("load", () => {
      setTimeout(() => {
        const loader = document.getElementById("loader");
        if (loader) loader.style.display = "none";
      }, 2000);
    });
  </script>
</body>
</html>
